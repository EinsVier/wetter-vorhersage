name: Plugin Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  syntax-check:
    name: PHP Syntax Check
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php-version: ['7.0', '7.4', '8.0', '8.1', '8.2']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          coverage: none

      - name: Check PHP syntax
        run: |
          find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l

      - name: Display PHP version
        run: php -v

  validate-files:
    name: Validate Plugin Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking required files..."
          test -f wetter-vorhersage.php || (echo "Main plugin file missing" && exit 1)
          test -f README.md || (echo "README.md missing" && exit 1)
          test -f CHANGELOG.md || (echo "CHANGELOG.md missing" && exit 1)
          test -f assets/weather.css || (echo "CSS file missing" && exit 1)
          echo "✓ All required files present"

      - name: Validate plugin header
        run: |
          echo "Validating plugin header..."
          grep -q "Plugin Name:" wetter-vorhersage.php || (echo "Plugin Name missing" && exit 1)
          grep -q "Version:" wetter-vorhersage.php || (echo "Version missing" && exit 1)
          grep -q "Author:" wetter-vorhersage.php || (echo "Author missing" && exit 1)
          echo "✓ Plugin header valid"

      - name: Check file permissions
        run: |
          echo "Checking file permissions..."
          find . -type f -name "*.php" -executable && exit 1 || echo "✓ No executable PHP files"
          echo "✓ File permissions correct"
